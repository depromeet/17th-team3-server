name: CD Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: deploy-to-ssolv-prod-server
      url: https://api.ssolv.site
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and Push with Jib
        run: |
          ./gradlew :ssolv-api-core:jib :ssolv-api-place:jib \
            -Djib.to.auth.username=${{ secrets.REGISTRY_USERNAME }} \
            -Djib.to.auth.password=${{ secrets.REGISTRY_PASSWORD }} \
            -Djava.net.preferIPv4Stack=true

      - name: EC2 Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/17th-team3-Server
            
            git fetch origin
            git reset --hard origin/main
            
            docker rmi -f registry.ssolv.site/core-server:latest registry.ssolv.site/place-server:latest || true
            
            docker-compose -f docker-compose.prod.yml pull
            
            docker-compose -f docker-compose.prod.yml stop core-server place-server nginx-app
            docker-compose -f docker-compose.prod.yml rm -f core-server place-server nginx-app
            
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "Waiting for services to be healthy..."
            sleep 10
            
            if docker-compose -f docker-compose.prod.yml ps | grep "unhealthy"; then
              echo "Deployment Failed! Some services are unhealthy."
              docker-compose -f docker-compose.prod.yml ps
              exit 1
            fi
            
            echo "Deployment Successful!"
            
            docker image prune -f