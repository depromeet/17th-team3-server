# 사용법 요약
# 1) 최초 실행 전 볼륨 디렉터리를 생성합니다.
#    mkdir -p ssolv-infrastructure/ngrinder/controller
#    mkdir -p ssolv-infrastructure/ngrinder/agent
# 2) 컨트롤러/에이전트를 기동합니다.
#    docker compose -f docker-compose.test-dev.yml up -d
# 3) 브라우저에서 http://<서버 IP>:16001 접속 후 웹 콘솔 사용
# 4) 중지 시 docker compose -f docker-compose.test-dev.yml down
#
# 포트 정보
# - 16001: 컨트롤러 웹 콘솔 (HTTP)
# - 16010: 컨트롤러-에이전트 제어 포트 (TCP)
#
# 주의사항
# - 에이전트를 추가하려면 아래 ngrinder-agent 블록을 복제하여 container_name만 변경하세요.
# - 컨트롤러 호스트명은 docker 네트워크 안에서 "ngrinder-controller"로 접근합니다.

services:
  ngrinder-controller:
    image: ngrinder/controller:3.5.9
    container_name: ngrinder-controller
    restart: unless-stopped
    ports:
      - "8000:80" # nGrinder 웹 콘솔 (HTTP)
      - "16010:16001" # 에이전트 제어 포트
    environment:
      - TZ=Asia/Seoul
      - NGRINDER_HOME=/opt/ngrinder-controller
    volumes:
      - ./ssolv-infrastructure/ngrinder/controller:/opt/ngrinder-controller
    networks:
      - ngrinder_network

  ngrinder-agent:
    image: ngrinder/agent:3.5.9
    container_name: ngrinder-agent
    restart: unless-stopped
    depends_on:
      - ngrinder-controller
    environment:
      - TZ=Asia/Seoul
    command: [ "ngrinder-controller:80" ]
    volumes:
      - ./ssolv-infrastructure/ngrinder/agent:/opt/ngrinder-agent
    networks:
      - ngrinder_network

  ngrinder-agent-2:
    image: ngrinder/agent:3.5.9
    container_name: ngrinder-agent-2
    restart: unless-stopped
    depends_on:
      - ngrinder-controller
    environment:
      - TZ=Asia/Seoul
    command: [ "ngrinder-controller:80" ]
    volumes:
      - ./ssolv-infrastructure/ngrinder/agent-2:/opt/ngrinder-agent
    networks:
      - ngrinder_network

  core-server-test:
    container_name: core-server-test
    image: registry.ssolv.site/core-server:latest
    pull_policy: never
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_URL=jdbc:mysql://host.docker.internal:3306/${DEFAULT_SCHEMA}
      - JAVA_TOOL_OPTIONS=-XX:MaxRAMPercentage=75.0
      - OTLP_ENDPOINT=http://alloy:4318/v1/traces
      # 필수 환경 변수
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - JWT_SECRET=${JWT_SECRET}
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY}
    networks:
      ngrinder_network:
        aliases:
          - core-server
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    mem_limit: 512m
    mem_reservation: 256m

  place-server-test:
    container_name: place-server-test
    image: registry.ssolv.site/place-server:latest
    pull_policy: never
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_URL=jdbc:mysql://host.docker.internal:3306/${DEFAULT_SCHEMA}
      - JAVA_TOOL_OPTIONS=-XX:MaxRAMPercentage=75.0
      - OTLP_ENDPOINT=http://alloy:4318/v1/traces
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY}
    networks:
      ngrinder_network:
        aliases:
          - place-server
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    mem_limit: 1024m
    mem_reservation: 512m

  nginx-test:
    container_name: nginx-test
    image: nginx:1.29.0
    ports:
      - "80:80"
    volumes:
      - ./ssolv-infrastructure/nginx/nginx-app.conf:/etc/nginx/nginx.conf:ro
    environment:
      - TZ=Asia/Seoul
    networks:
      - ngrinder_network
    restart: always
    depends_on:
      - core-server-test
      - place-server-test
    mem_limit: 256m

networks:
  ngrinder_network: